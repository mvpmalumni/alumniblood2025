<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Mega Blood Donation Camp 2025</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        header { background: #b30000; color: white; padding: 15px; text-align: center; font-size: 20px; font-weight: bold; }
        #container { padding: 10px; }
        label { font-weight: bold; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; }
        #suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; }
        .item { padding: 8px; cursor: pointer; }
        .item:hover { background: #eee; }
        #map { height: 400px; margin-top: 10px; }
        button { width: 100%; padding: 12px; background: #b30000; color: white; border: none; font-size: 16px; cursor: pointer; }
        button:hover { background: #800000; }
    </style>
</head>
<body>

<header>
    Mega Blood Donation Camp 2025<br>
    Organized by MVPM Alumni & MVPM across Maharashtra
</header>

<div id="container">
    <label>Select City</label>
    <input type="text" id="cityInput" placeholder="Type city name..." autocomplete="off">

    <div id="citySuggestions"></div>

    <label>Select Area</label>
    <input type="text" id="areaInput" placeholder="Type area name..." autocomplete="off">

    <div id="areaSuggestions"></div>

    <button onclick="useMyLocation()">Use My Current Location</button>

    <div id="map"></div>

    <h3 id="result"></h3>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let areas = [];
let centres = [];

// Load Maharashtra Areas CSV
fetch("maharashtra_locations.csv")
.then(res => res.text())
.then(data => {
    areas = data.split("\n").map(r => r.trim()).filter(r => r);
});

// Load Centres CSV
fetch("centres.csv")
.then(res => res.text())
.then(data => {
    centres = data.split("\n").slice(1).map(r => {
        let [name, city, area, lat, lng] = r.split(",");
        return { name, city, area, lat: parseFloat(lat), lng: parseFloat(lng) };
    });
});

// MAP
let map = L.map('map').setView([19.7515, 75.7139], 6); // Maharashtra center

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
}).addTo(map);

// Autocomplete function
function setupAutocomplete(inputId, suggestionId, list) {
    const input = document.getElementById(inputId);
    const suggestionBox = document.getElementById(suggestionId);

    input.addEventListener("input", () => {
        const val = input.value.toLowerCase();
        suggestionBox.innerHTML = "";

        const matches = list.filter(x => x.toLowerCase().startsWith(val)).slice(0, 30);

        matches.forEach(m => {
            let div = document.createElement("div");
            div.className = "item";
            div.textContent = m;
            div.onclick = () => {
                input.value = m;
                suggestionBox.innerHTML = "";
                if (inputId === "areaInput") findNearestByArea(m);
            };
            suggestionBox.appendChild(div);
        });
    });
}

// Suggest cities & areas
setupAutocomplete("cityInput", "citySuggestions", areas);
setupAutocomplete("areaInput", "areaSuggestions", areas);

// Find nearest centre
function findNearestByArea(areaName) {
    const filtered = centres.filter(c => c.area.toLowerCase() === areaName.toLowerCase());

    if (filtered.length === 0) {
        document.getElementById("result").textContent = "No centre found";
        return;
    }
    const c = filtered[0];

    L.marker([c.lat, c.lng]).addTo(map).bindPopup(c.name).openPopup();
    map.setView([c.lat, c.lng], 15);

    document.getElementById("result").textContent = "Nearest Centre: " + c.name;
}

// Use My Location
function useMyLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        let userLat = pos.coords.latitude;
        let userLng = pos.coords.longitude;

        let nearest = null;
        let minDist = Infinity;

        centres.forEach(c => {
            let d = Math.hypot(c.lat - userLat, c.lng - userLng);
            if (d < minDist) {
                minDist = d;
                nearest = c;
            }
        });

        if (nearest) {
            L.marker([nearest.lat, nearest.lng]).addTo(map).bindPopup(nearest.name).openPopup();
            map.setView([nearest.lat, nearest.lng], 15);
            document.getElementById("result").textContent = "Nearest Centre: " + nearest.name;
        }
    });
}
</script>

</body>
</html>